# .github/workflows/cd.yml
name: CD - Build & Push to Artifact Registry (with CML report)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write  # required by CML to post comments
  id-token: write  # required for google-github-actions/auth

env:
  IMAGE_NAME: ${{ secrets.IMAGE_NAME || 'fraud-detector' }}
  REGION: ${{ secrets.REGION }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure docker for Artifact Registry
        run: |
          # artifact registry docker host is REGION-docker.pkg.dev
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet
        env:
          REGION: ${{ secrets.REGION }}

      - name: Determine image URI
        id: image_uri
        run: |
          IMAGE_NAME="${{ secrets.IMAGE_NAME || 'fraud-detector' }}"
          IMAGE_URI="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.ARTIFACT_REGISTRY_REPOSITORY }}/${IMAGE_NAME}:${GITHUB_SHA}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_OUTPUT
        env:
          REGION: ${{ secrets.REGION }}

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_URI .
        env:
          IMAGE_URI: ${{ steps.image_uri.outputs.IMAGE_URI }}

      - name: Push Docker image to Artifact Registry
        run: |
          docker push $IMAGE_URI
        env:
          IMAGE_URI: ${{ steps.image_uri.outputs.IMAGE_URI }}

      - name: Tag and push latest
        run: |
          IMAGE_NAME="${{ steps.image_uri.outputs.IMAGE_NAME }}"
          LATEST_URI="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.ARTIFACT_REGISTRY_REPOSITORY }}/${IMAGE_NAME}:latest"
          docker tag $IMAGE_URI $LATEST_URI
          docker push $LATEST_URI
          echo "LATEST_URI=${LATEST_URI}" >> $GITHUB_ENV
        env:
          REGION: ${{ secrets.REGION }}
          IMAGE_URI: ${{ steps.image_uri.outputs.IMAGE_URI }}

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Create CML report and post comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_URI: ${{ steps.image_uri.outputs.IMAGE_URI }}
        run: |
          echo "## Build & Push Report ðŸš€" > report.md
          echo "" >> report.md
          echo "### Image Details" >> report.md
          echo "- **Image URI:** \`$IMAGE_URI\`" >> report.md
          echo "- **Latest URI:** \`$LATEST_URI\`" >> report.md
          echo "- **Commit:** \`${GITHUB_SHA}\`" >> report.md
          echo "- **Status:** âœ… **SUCCESS**" >> report.md
          echo "" >> report.md
          echo "### Docker Image Info" >> report.md
          echo "\`\`\`" >> report.md
          docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" | grep -E "fraud-detector|REPOSITORY" | head -n 5 >> report.md || true
          echo "\`\`\`" >> report.md
          # post comment on PR/commit
          cml comment create report.md
